#!/bin/bash
if [ "$EUID" -ne 0 ]; then
    echo "Please run as root";
    exit
fi

if test -f '/tmp/btrbk.sh.pid'; then
    /usr/bin/sudo -u lucas /bin/bash -c 'XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus DISPLAY=:0  mpv /mnt/archlinux/ROOT/usr/lib/libreoffice/share/gallery/sounds/911.wav'
#     /usr/bin/sudo -u lucas /bin/bash -c 'XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus DISPLAY=:0 notify-send "Você está jogando demais!"'
    exit;
fi
 
touch /tmp/btrbk.sh.pid

if [[ ! "$(mount | grep '/dev/sda2 on / type btrfs')" == *"subvol=/ROOT)"* ]]; then
    notify-send 'Você não está no subvolume ROOT. Snapshot não foi criado.';
fi

while [ -n "$(pgrep UNO)" ] || [ -n "$(pgrep Diablo)" ] ||  [ -n "$(pgrep qemu)" ];
do
   sleep 10;
done


btrbk -c /etc/btrbk/btrbk_home.conf -q run;
if [ "$?" != "0" ]; then
    /usr/bin/sudo -u lucas /bin/bash -c 'XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus DISPLAY=:0  mpv /mnt/archlinux/ROOT/usr/lib/libreoffice/share/gallery/sounds/911.wav'
#     /usr/bin/sudo -u lucas /bin/bash -c 'XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus DISPLAY=:0 notify-send "BTRBK: Erro ao criar snapshot HOME"'
fi

btrbk -c /etc/btrbk/btrbk_root.conf -q run;  
if [ "$?" != "0" ]; then
    /usr/bin/sudo -u lucas /bin/bash -c 'XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus DISPLAY=:0  mpv /mnt/archlinux/ROOT/usr/lib/libreoffice/share/gallery/sounds/911.wav'
#     /usr/bin/sudo -u lucas /bin/bash -c 'XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus DISPLAY=:0 notify-send "BTRBK: Erro ao criar snapshot ROOT"'
fi
rm /tmp/btrbk.sh.pid;

