#!/bin/bash
if [ -z "$(ls /dev/dri/ | grep card1)" ];then
    cp /etc/pulse/default.pa_intel /etc/pulse/default.pa
    echo 'iGPU desativada. Copiando arquivo pertinente(default.pa_intel).'
    exit 0
fi  
contador=0
contador_=0
{
sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list
while [ ! $? -eq 0 ]; do
    contador_=$(($contador_ + 1))
	sleep 2;
	echo 'Aguardando pulseaudio '$contador_
	sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list
done
} &> /dev/null

if [[ -n "$(sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list sources | /usr/bin/grep 'hw:2')" || -n "$(sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list sources | /usr/bin/grep 'hw:1')" ]];then
    if [ -z "$(sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list sources | /usr/bin/grep -E 'USB|CAMERA')" ];then
        exit 0;
    fi

fi

while :;do
    contador=$(($contador + 1))
    if [ `expr $contador % 2` == 0 ];then
        cp /etc/pulse/default.pa_2 /etc/pulse/default.pa;
    else
        cp /etc/pulse/default.pa_1 /etc/pulse/default.pa;
    fi
    sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pulseaudio -k  
    sleep 1
    if [[ -n "$(sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list sources | /usr/bin/grep 'hw:2')" || -n "$(sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list sources | /usr/bin/grep 'hw:1')" ]];then
        if [ -z "$(sudo -u lucas XDG_RUNTIME_DIR=/run/user/1000 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus /usr/bin/pactl list sources | /usr/bin/grep -E 'USB|CAMERA')" ];then
            break;
        fi
    fi

done
    
